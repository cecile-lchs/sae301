{% extends 'admin/base.html.twig' %}
{% block main %}

    <!-- Main Content -->
    <main class="dashboard-main planning-page">
        <header class="dashboard-header d-flex justify-content-between align-items-center bg-white border-bottom p-4">
            <h2>Planning</h2>
            <a href="parametres.html" class="d-flex align-items-center text-decoration-none">
                <div class="bg-primary text-white rounded-circle d-flex justify-content-center align-items-center shadow-sm" style="width: 48px; height: 48px; font-weight: bold;">
                    JH
                </div>
            </a>
        </header>

        <div class="dashboard-content p-0 h-100">
            <div class="planning-container h-100 d-flex">
                <!-- Left Panel (Restored) -->
                <div class="planning-left-panel p-4 border-end bg-white" style="width: 300px; min-width: 300px;">
                    <div class="mini-calendar-widget mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="m-0 fw-bold">Octobre 2026</h6>
                            <div><small>&lt;</small> <small>&gt;</small></div>
                        </div>
                        <table class="table table-sm text-center small borderless-table">
                            <thead><tr><th>L</th><th>M</th><th>M</th><th>J</th><th>V</th><th>S</th><th>D</th></tr></thead>
                            <tbody>
                            <tr><td class="text-muted">28</td><td class="text-muted">29</td><td class="text-muted">30</td><td>1</td><td>2</td><td>3</td><td>4</td></tr>
                            <tr><td>5</td><td>6</td><td class="has-event">7</td><td class="bg-primary text-white rounded-circle">8</td><td class="has-event">9</td><td>10</td><td>11</td></tr>
                            <tr><td>12</td><td>13</td><td class="has-event">14</td><td>15</td><td>16</td><td>17</td><td>18</td></tr>
                            <tr><td>19</td><td>20</td><td>21</td><td>22</td><td>23</td><td>24</td><td>25</td></tr>
                            <tr><td>26</td><td>27</td><td>28</td><td>29</td><td>30</td><td>31</td><td class="text-muted">1</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Details Panel (Hidden by default) -->
                    <div id="planning-details-container" class="fade-in" style="display: none;">
                        <h6 class="fw-bold mb-3 border-bottom pb-2">Détails de l'intervention</h6>
                        <div class="card border-0 bg-light mb-3">
                            <div class="card-body p-3">
                                <h5 class="fw-bold text-primary mb-1" id="detail-title">Titre</h5>
                                <div class="text-muted small mb-2" id="detail-time"><i class="bi bi-clock me-1"></i> <span>00:00</span></div>
                                <div class="mb-3">
                                    <small class="text-uppercase fw-bold text-muted" style="font-size: 0.7rem;">Client</small>
                                    <div class="fw-bold" id="detail-client">Nom Client</div>
                                </div>
                                <div class="mb-3">
                                    <small class="text-uppercase fw-bold text-muted" style="font-size: 0.7rem;">Adresse</small> <!-- Fixed typo from text-mutes -->
                                    <div class="small" id="detail-address">Adresse</div>
                                </div>
                                <div>
                                    <small class="text-uppercase fw-bold text-muted" style="font-size: 0.7rem;">Notes</small>
                                    <p class="small text-muted mb-0" id="detail-desc">Description...</p>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-primary w-100" onclick="closeDetails()">Fermer</button>
                    </div>

                    <div id="planning-empty-state" class="mt-4 text-center text-muted">
                        <i class="bi bi-calendar4-week fs-3 mb-2"></i>
                        <p class="small">Cliquez sur une tâche pour voir les détails.</p>
                    </div>
                </div>

                <!-- Main Calendar View (Right Panel) -->
                <div class="planning-main-view flex-grow-1 p-4 d-flex flex-column h-100 overflow-hidden">
                    <!-- Toolbar -->
                    <div class="calendar-toolbar d-flex justify-content-between align-items-center mb-4 flex-shrink-0">
                        <div class="d-flex align-items-center gap-3">
                            <h4 class="m-0 fw-bold">Octobre 2026</h4>
                            <span class="badge bg-light text-dark border">Aujourd'hui</span>
                            <div class="nav-arrows">
                                <button class="btn btn-sm btn-light">&lt;</button>
                                <button class="btn btn-sm btn-light">&gt;</button>
                            </div>
                        </div>
                        <div class="view-toggles">
                            <div class="btn-group btn-group-sm" role="group">
                                <input type="radio" class="btn-check" name="viewMode" id="btnDay" autocomplete="off" onchange="switchView('day')">
                                <label class="btn btn-outline-secondary" for="btnDay">Jour</label>

                                <input type="radio" class="btn-check" name="viewMode" id="btnWeek" autocomplete="off" checked onchange="switchView('week')">
                                <label class="btn btn-outline-secondary" for="btnWeek">Semaine</label>

                                <input type="radio" class="btn-check" name="viewMode" id="btnMonth" autocomplete="off" onchange="switchView('month')">
                                <label class="btn btn-outline-secondary" for="btnMonth">Mois</label>
                            </div>
                        </div>
                    </div>

                    <!-- VIEWS CONTAINER -->
                    <div class="views-container flex-grow-1 overflow-auto position-relative border rounded bg-white">

                        <!-- WEEK VIEW -->
                        <!-- WEEK VIEW -->
                        <div id="view-week" class="view-section h-100 d-flex flex-column">
                            <!-- Week Header (reste identique) -->
                            <div class="grid-header-row d-flex border-bottom bg-light">
                                <div class="time-col-spacer border-end" style="width: 60px;"></div>
                                {% for day in 0..6 %}
                                    <div class="day-col flex-grow-1 text-center py-2 border-end"><small class="text-muted">{{ ['LUN','MAR','MER','JEU','VEN','SAM','DIM'][day] }}</small><div>{{ 12 + day }}</div></div>
                                {% endfor %}
                            </div>

                            <!-- Week Body -->
                            <div class="grid-body position-relative flex-grow-1">
                                <div class="position-absolute top-0 start-0 bottom-0 bg-light border-end" style="width: 60px; z-index: 10;">
                                    {% for hour in 8..14 %}
                                        <div class="time-slot border-bottom text-muted small text-center py-2" style="height: 60px;">{{ hour }}h</div>
                                    {% endfor %}
                                </div>

                                <div class="position-absolute top-0 start-0 bottom-0 end-0 ms-5" style="margin-left: 60px !important;">
                                    <div class="d-flex h-100 position-absolute top-0 start-0 w-100 pointer-events-none">
                                        {% for i in 0..6 %}
                                            <div class="flex-grow-1 border-end"></div>
                                        {% endfor %}
                                    </div>

                                    {% for event in events %}
                                        {% set top = (event.heure_debut[:2]|int - 8) * 60 %} {# 8h = top:0 #}
                                        {% set height = (event.heure_fin[:2]|int - event.heure_debut[:2]|int) * 60 %}
                                        <div class="position-absolute bg-primary text-white rounded p-2 shadow-sm small event-item cursor-pointer"
                                             onclick="showEventDetails(this)"
                                             data-title="{{ event.title|default('Service') }}"
                                             data-client="{{ event.client }}"
                                             data-time="{{ event.time }}"
                                             data-address="{{ event.address }}"
                                             data-desc="{{ event.desc|default('') }}"
                                             style="top: {{ top }}px; left: 0%; width: 14.28%; height: {{ height }}px; border-left: 4px solid #0d6efd; opacity: 0.9; cursor: pointer;">
                                            <div class="fw-bold">{{ event.client }}</div>
                                            <div>{{ event.title }}</div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- DAY VIEW -->
                        <div id="view-day" class="view-section h-100 d-none flex-column p-4">
                            <div class="d-flex align-items-start mb-4 border-bottom pb-3">
                                <div class="me-4 text-muted fw-bold" style="width: 60px;">09:00</div>
                                <div class="flex-grow-1 p-3 bg-primary-subtle border border-primary-subtle rounded event-item cursor-pointer"
                                     onclick="showEventDetails(this)"
                                     data-title="Tonte standard"
                                     data-client="Mme. Martin"
                                     data-time="09:00 - 11:00"
                                     data-address="8 Avenue des Roses, Lyon"
                                     data-desc="Tonte de la pelouse avant et arrière. Ramassage des déchets verts."
                                     style="cursor: pointer;">
                                    <h5 class="fw-bold text-primary mb-1">Mme. Martin - Tonte</h5>
                                    <p class="mb-0 text-muted"><i class="bi bi-geo-alt me-1"></i> 8 Avenue des Roses, Lyon</p>
                                </div>
                            </div>
                            <div class="d-flex align-items-start mb-4 border-bottom pb-3">
                                <div class="me-4 text-muted fw-bold" style="width: 60px;">14:00</div>
                                <div class="flex-grow-1 p-3 bg-success-subtle border border-success-subtle rounded event-item cursor-pointer"
                                     onclick="showEventDetails(this)"
                                     data-title="Plantation Haies"
                                     data-client="M. Dupont"
                                     data-time="14:00 - 17:00"
                                     data-address="12 Rue des Lilas, Paris"
                                     data-desc="Plantation de 15 thuyas le long de la clôture sud."
                                     style="cursor: pointer;">
                                    <h5 class="fw-bold text-success mb-1">M. Dupont - Plantation</h5>
                                    <p class="mb-0 text-muted"><i class="bi bi-geo-alt me-1"></i> 12 Rue des Lilas, Paris</p>
                                </div>
                            </div>
                        </div>

                        <!-- MONTH VIEW -->
                        <div id="view-month" class="view-section h-100 d-none flex-column">
                            <div class="d-flex text-center fw-bold bg-light py-2 border-bottom">
                                {% for day in ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'] %}
                                    <div class="flex-fill">{{ day }}</div>
                                {% endfor %}
                            </div>

                            <div class="flex-grow-1">
                                <div class="row row-cols-7 g-0 h-100" id="main-month-grid">
                                    {% for day in 1..31 %}
                                        <div class="col border p-1 fw-bold position-relative" style="min-height: 100px;">
                                            <span>{{ day }}</span>

                                            {% for event in events %}
                                 -               {% if event.date == day %}
                                                    <div class="badge bg-primary d-block text-truncate mt-1 event-item cursor-pointer"
                                                         onclick="event.stopPropagation(); showEventDetails(this)"
                                                         data-title="{{ event.title }}"
                                                         data-client="{{ event.client }}"
                                                         data-time="{{ event.time }}"
                                                         data-address="{{ event.address }}"
                                                         data-desc="{{ event.desc }}">
                                                        {{ event.client }}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    </div>
        </div>
    </main>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
    function switchView(viewName) {
        // Hide all views
        document.querySelectorAll('.view-section').forEach(el => {
            el.classList.remove('d-flex');
            el.classList.add('d-none');
        });

        // Show selected view
        const selectedView = document.getElementById('view-' + viewName);
        if (selectedView) {
            selectedView.classList.remove('d-none');
            selectedView.classList.add('d-flex');
        }
    }

    function showEventDetails(element) {
        // Get data from attributes
        const title = element.getAttribute('data-title');
        const client = element.getAttribute('data-client');
        const time = element.getAttribute('data-time');
        const address = element.getAttribute('data-address');
        const desc = element.getAttribute('data-desc');

        // Populate details
        document.getElementById('detail-title').innerText = title;
        document.getElementById('detail-client').innerText = client;
        document.getElementById('detail-time').innerHTML = `<i class="bi bi-clock me-1"></i> ${time}`;
        document.getElementById('detail-address').innerText = address;
        document.getElementById('detail-desc').innerText = desc;

        // Toggle visibility
        document.getElementById('planning-empty-state').style.display = 'none';
        document.getElementById('planning-details-container').style.display = 'block';
    }

    function closeDetails() {
        document.getElementById('planning-details-container').style.display = 'none';
        document.getElementById('planning-empty-state').style.display = 'block';
    }
</script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<!-- Custom JS for Map and Calendar -->

<script>
    let currentDate = new Date();
    const monthNames = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];

    document.addEventListener('DOMContentLoaded', function () {
        renderCalendar();
    });

    function changeMonth(step) {
        currentDate.setMonth(currentDate.getMonth() + step);
        renderCalendar();
    }

    function goToToday() {
        currentDate = new Date();
        renderCalendar();
    }

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        // Update Titles
        const title = `${monthNames[month]} ${year}`;
        const mainTitle = document.getElementById('main-calendar-title');
        const miniTitle = document.getElementById('mini-calendar-title');

        if (mainTitle) mainTitle.innerText = title;
        if (miniTitle) miniTitle.innerText = title;

        // Calendar Data construction
        const firstDayIndex = new Date(year, month, 1).getDay(); // 0 is Sunday
        // Adjust for Monday first: 0->6, 1->0, etc.
        const startingDay = firstDayIndex === 0 ? 6 : firstDayIndex - 1;

        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Render Mini Calendar
        renderMiniCalendar(startingDay, daysInMonth);

        // Render Main Month View
        renderMainMonthGrid(startingDay, daysInMonth);
    }

    function renderMiniCalendar(startDay, daysCount) {
        const tbody = document.getElementById('mini-calendar-body');
        if (!tbody) return;

        tbody.innerHTML = '';
        let date = 1;
        let row = document.createElement('tr');

        // Empty cells before start
        for (let i = 0; i < startDay; i++) {
            const cell = document.createElement('td');
            cell.classList.add('text-muted');
            row.appendChild(cell);
        }

        for (let i = startDay; i < 7; i++) {
            if (date > daysCount) break;
            const cell = document.createElement('td');
            cell.innerText = date;
            if (isToday(date)) {
                cell.classList.add('bg-primary', 'text-white', 'rounded-circle');
            }
            row.appendChild(cell);
            date++;
        }
        tbody.appendChild(row);

        while (date <= daysCount) {
            row = document.createElement('tr');
            for (let i = 0; i < 7; i++) {
                if (date > daysCount) {
                    const cell = document.createElement('td');
                    row.appendChild(cell);
                } else {
                    const cell = document.createElement('td');
                    cell.innerText = date;
                    if (isToday(date)) {
                        cell.classList.add('bg-primary', 'text-white', 'rounded-circle');
                    }
                    row.appendChild(cell);
                    date++;
                }
            }
            tbody.appendChild(row);
        }
    }

    function renderMainMonthGrid(startDay, daysCount) {
        const grid = document.getElementById('main-month-grid');
        if (!grid) return;

        grid.innerHTML = '';
        let date = 1;

        // Fill blanks
        for (let i = 0; i < startDay; i++) {
            const div = document.createElement('div');
            div.className = 'col border p-1 bg-light';
            grid.appendChild(div);
        }

        // Fill days
        // We need 42 cells (6 rows * 7 cols) to keep grid stable, or just auto-fill
        // The previous design used row-cols-7

        while (date <= daysCount) {
            const div = document.createElement('div');
            div.className = 'col border p-1 fw-bold position-relative';
            div.style.minHeight = '100px';

            div.innerHTML = `<span>${date}</span>`;

            // Example mock event on the 14th
            if (date === 14) {
                div.classList.add('bg-primary-subtle');
                div.classList.add('cursor-pointer');
                div.innerHTML += `
                        <div class="badge bg-primary d-block text-truncate mt-1 event-item"
                             onclick="event.stopPropagation(); showEventDetailsFromData(this)"
                             data-title="Tonte standard"
                             data-client="Mme. Martin"
                             data-time="09:00 - 11:00"
                             data-address="8 Avenue des Roses, Lyon"
                             data-desc="Tonte de la pelouse avant et arrière.">
                            Mme Martin
                        </div>
                     `;
            }

            if (isToday(date)) {
                div.style.backgroundColor = 'rgba(13, 110, 253, 0.05)';
                div.querySelector('span').classList.add('badge', 'bg-primary');
            }

            grid.appendChild(div);
            date++;
        }

        // Fill remaining cells to look nice (optional but good for grid)
        const totalCells = grid.children.length;
        const remaining = 7 - (totalCells % 7);
        if (remaining < 7) {
            for (let i = 0; i < remaining; i++) {
                const div = document.createElement('div');
                div.className = 'col border p-1 bg-light';
                grid.appendChild(div);
            }
        }
    }

    function isToday(date) {
        const today = new Date();
        return date === today.getDate() &&
            currentDate.getMonth() === today.getMonth() &&
            currentDate.getFullYear() === today.getFullYear();
    }

    // Function helper to reuse the showEventDetails logic if needed,
    // though the original HTML one works if data attributes are present.
    function showEventDetailsFromData(element) {
        // This wrapper is needed because renderMainMonthGrid creates dynamic elements
        // that might need to trigger the global showEventDetails function defined in HTML
        if (window.showEventDetails) {
            window.showEventDetails(element);
        }
    }
</script>
{% endblock %}
