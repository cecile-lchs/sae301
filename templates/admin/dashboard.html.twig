<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Admin</title>
    <link rel="stylesheet" href="{{ asset('styles/app.css') }}">



{#<h1>Dashboard Admin</h1>#}

{#<p>Bienvenue {{ app.user.email }}</p>#}
{#<ul>#}
{#    <li><a href="/admin/reservations">R√©servations</a></li>#}
{#    <li><a href="/admin/planning">Planning</a></li>#}
{#    <li><a href="/admin/indisponibilites">Indisponibilit√©s</a></li>#}
{#</ul>#}

{#<a href="{{ path('app_logout') }}">D√©connexion</a>#}
{#<a href="/logout">D√©connexion</a>#}

{#<!DOCTYPE html>#}
{#<html lang="fr">#}
{#<head>#}
{#    <meta charset="UTF-8">#}
{#    <meta name="viewport" content="width=device-width, initial-scale=1.0">#}
{#    <title>Jardins Harmonie - Dashboard</title>#}


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap" rel="stylesheet">


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">


    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <link rel="stylesheet" href="css/styles.css">
</head>

    <style>
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 12px;
            z-index: 1;
        }
    </style>

<body class="dashboard-body">

<div class="dashboard-container">
    <!-- Sidebar -->
    {# ================= SIDEBAR ================= #}
    <aside class="dashboard-sidebar">
        <div class="sidebar-header">
            <img src="{{ asset('images/logo.svg') }}" alt="Jardins Harmonie" class="sidebar-logo">
        </div>

        <nav class="sidebar-nav">
            <ul>
                <li>
                    <a href="{{ path('admin_dashboard') }}">
                        <span class="icon">üè†</span> Accueil
                    </a>
                </li>
                <li>
                    <a href="{{ path('admin_reservation') }}">
                        <span class="icon">üìÖ</span> R√©servations
                    </a>
                </li>
                <li>
                    <a href="{{ path('admin_client') }}" class="active">
                        <span class="icon">üë•</span> Clients
                    </a>
                </li>
                <li>
                    <a href="{{ path('admin_client') }}" class="active">
                        <span class="icon">üë•</span> Plannings
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="dashboard-main">
        <header class="dashboard-header d-flex justify-content-between align-items-center bg-white border-bottom p-4">
            <h2>Accueil</h2>
            <a href="{{ path('admin_parametres') }}">
                <div class="bg-primary text-white rounded-circle d-flex justify-content-center align-items-center"
                     style="width: 48px; height: 48px; font-weight: bold;">
                    {{ app.user.email|slice(0,2)|upper }}
                </div>
            </a>
        </header>

        <div class="dashboard-content">
            <!-- Stats Row -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="stat-card">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-info">
                            <span class="stat-label">Nombre de r√©servations</span>
                            <span class="stat-value">{{ totalReservations }}</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stat-card">
                        <div class="stat-icon">üë§</div>
                        <div class="stat-info">
                            <span class="stat-label">Nombre de clients</span>
                            <span class="stat-value">{{ totalClients }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Left Column: Map & List -->
                <div class="col-lg-8">
                    <!-- Map Section -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Carte des clients</h5>
                            <div id="map"></div>
                        </div>
                    </div>

                    <!-- Reservations List -->
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Liste des r√©servations</h5>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead>
                                    <tr>
                                        <th>N¬∞</th>
                                        <th>Nom</th>
                                        <th>Date</th>
                                        <th>Service</th>
                                        <th>Dur√©e</th>
                                        <th>Statut</th>
                                        <th>Action</th>
                                    </tr>
                                    </thead>
                                    <tbody id="reservations-table-body">
                                    <!-- Rows generated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Calendar & Availability -->
                <div class="col-lg-4">
                    <!-- Calendar Widget -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="calendar-header d-flex justify-content-between align-items-center mb-3">
                                <button class="btn btn-sm btn-link">&lt;</button>
                                <h5 class="m-0">Octobre 2026</h5>
                                <button class="btn btn-sm btn-link">&gt;</button>
                            </div>
                            <div class="calendar-grid" id="calendar-grid">
                                <!-- Headers -->
{#                                <div class="row text-center fw-bold text-muted small mb-2">#}
{#                                    <div class="col">Lu</div>#}
{#                                    <div class="col">Ma</div>#}
{#                                    <div class="col">Me</div>#}
{#                                    <div class="col">Je</div>#}
{#                                    <div class="col">Ve</div>#}
{#                                    <div class="col">Sa</div>#}
{#                                    <div class="col">Di</div>#}
{#                                </div>#}
                                <!-- Days will be generated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Availability List -->
                    <div class="availability-list" id="daily-schedule-container">
                        <!-- Daily schedule items generated by JS -->
                        <p class="text-muted text-center py-3">S√©lectionnez une date pour voir les disponibilit√©s.</p>
                    </div>

                    <button class="btn btn-primary w-100 mt-3 d-flex align-items-center justify-content-center gap-2">
                        <span>+</span> Ajouter indisponibilit√©
                    </button>
                </div>
            </div>
        </div>
    </main>
</div>
{#<pre>{{ dump(reservations) }}</pre>#}


<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<!-- Custom JS for Map and Calendar -->
{#<script>#}
{#    document.addEventListener('DOMContentLoaded', function () {#}

{#        // --- DONN√âES depuis Symfony ---#}
{#        const reservationsData = {{ reservations|json_encode|raw }};#}
{#        const defaultCenter = [48.8566, 2.3522]; // Paris par d√©faut#}
{#        const currentYear = 2026;#}
{#        const currentMonth = 9; // Octobre (0-index√©)#}

{#        let map;#}
{#        let markers = [];#}

{#        // --- INIT ---#}
{#        initMap();#}
{#        renderReservationsTable(reservationsData);#}
{#        initCalendar(currentYear, currentMonth);#}
{#        updateCalendarEvents(reservationsData);#}

{#        // Auto-selection 4 octobre#}
{#        updateDailySchedule(`${currentYear}-10-04`);#}

{#        // =========================#}
{#        // CARTE#}
{#        // =========================#}
{#        function initMap() {#}
{#            map = L.map('map').setView(defaultCenter, 11);#}
{#            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {#}
{#                attribution: '&copy; OpenStreetMap contributors'#}
{#            }).addTo(map);#}
{#            addMapMarkers(reservationsData);#}
{#        }#}

{#        function addMapMarkers(data) {#}
{#            const bounds = [];#}
{#            data.forEach(res => {#}
{#                if (res.lat && res.lng) {#}
{#                    const marker = L.marker([res.lat, res.lng]).addTo(map);#}
{#                    marker.bindPopup(`<strong>${res.nom}</strong><br>${res.adresse ?? 'Adresse inconnue'}<br><em>${res.service}</em>`);#}
{#                    markers.push(marker);#}
{#                    bounds.push([res.lat, res.lng]);#}
{#                }#}
{#            });#}
{#            if (bounds.length) map.fitBounds(bounds, { padding: [50, 50] });#}
{#        }#}

{#        // =========================#}
{#        // TABLEAU#}
{#        // =========================#}
{#        function renderReservationsTable(data) {#}
{#            const tbody = document.getElementById('reservations-table-body');#}
{#            tbody.innerHTML = '';#}
{#            data.forEach(res => {#}
{#                const row = document.createElement('tr');#}
{#                row.innerHTML = `#}
{#                <td>${res.id}</td>#}
{#                <td>${res.nom}</td>#}
{#                <td>${formatDate(res.date)}</td>#}
{#                <td>${res.service}</td>#}
{#                <td>${res.duree} min</td>#}
{#                <td><span class="badge bg-success">${res.statut}</span></td>#}
{#                <td><a href="#" class="text-decoration-underline text-dark">Voir plus</a></td>#}
{#            `;#}
{#                tbody.appendChild(row);#}
{#            });#}
{#        }#}

{#        function formatDate(dateStr) {#}
{#            if (!dateStr) return '‚Äî';#}
{#            const [y,m,d] = dateStr.split('-');#}
{#            return `${d}/${m}/${y}`;#}
{#        }#}

{#        // =========================#}
{#        // CALENDRIER#}
{#        // =========================#}
{#        function initCalendar(year, month) {#}
{#            const grid = document.getElementById('calendar-grid');#}
{#            grid.innerHTML = '';#}

{#            // 1Ô∏è‚É£ Noms des jours#}
{#            const daysOfWeek = ['Lu','Ma','Me','Je','Ve','Sa','Di'];#}
{#            daysOfWeek.forEach(day => {#}
{#                const el = document.createElement('div');#}
{#                el.className = 'day-name';#}
{#                el.textContent = day;#}
{#                grid.appendChild(el);#}
{#            });#}

{#            // 2Ô∏è‚É£ D√©calage du premier jour#}
{#            const firstDay = new Date(year, month, 1).getDay(); // 0 = dimanche#}
{#            let startDay = firstDay - 1;#}
{#            if (startDay < 0) startDay = 6;#}

{#            for(let i=0; i<startDay; i++){#}
{#                const empty = document.createElement('div');#}
{#                grid.appendChild(empty);#}
{#            }#}

{#            // 3Ô∏è‚É£ Jours du mois#}
{#            const daysInMonth = new Date(year, month+1, 0).getDate();#}
{#            for(let day=1; day<=daysInMonth; day++){#}
{#                const btn = document.createElement('button');#}
{#                btn.className = 'day-btn';#}
{#                btn.textContent = day;#}
{#                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;#}
{#                btn.dataset.date = dateStr;#}

{#                if(reservationsData.some(r => r.date === dateStr)){#}
{#                    btn.classList.add('has-reservation');#}
{#                }#}

{#                btn.addEventListener('click', function(){#}
{#                    document.querySelectorAll('.day-btn').forEach(c => c.classList.remove('selected'));#}
{#                    this.classList.add('selected');#}
{#                    updateDailySchedule(dateStr);#}
{#                });#}

{#                grid.appendChild(btn);#}
{#            }#}

{#            // Auto-selection 4 octobre#}
{#            const todayBtn = grid.querySelector(`.day-btn[data-date="${year}-10-04"]`);#}
{#            if(todayBtn) todayBtn.classList.add('selected');#}
{#        }#}



{#        // Ajoute un point pour chaque jour avec r√©servation#}
{#        function updateCalendarEvents(data) {#}
{#            const reservedDates = new Set(data.map(r => r.date));#}
{#            reservedDates.forEach(dateStr => {#}
{#                const btn = document.querySelector(`.calendar-grid .day-btn[data-date="${dateStr}"]`);#}
{#                if (btn) btn.classList.add('has-reservation');#}
{#            });#}
{#        }#}

{#        // =========================#}
{#        // SCHEDULE#}
{#        // =========================#}
{#        function updateDailySchedule(dateStr) {#}
{#            const container = document.getElementById('daily-schedule-container');#}
{#            container.innerHTML = '';#}
{#            const dayReservations = reservationsData.filter(r => r.date === dateStr);#}

{#            if (!dayReservations.length) {#}
{#                container.innerHTML = `<p class="text-muted text-center py-3">Aucune r√©servation pour le ${formatDate(dateStr)}</p>`;#}
{#                return;#}
{#            }#}

{#            dayReservations.forEach(res => {#}
{#                const card = document.createElement('div');#}
{#                card.className = 'card mb-3 availability-card';#}
{#                card.innerHTML = `#}
{#                <div class="card-body d-flex justify-content-between align-items-center">#}
{#                    <div>#}
{#                        <div class="fw-bold">${res.nom}</div>#}
{#                        <div class="small text-muted">${res.heure_debut || ''}-${res.heure_fin || ''}</div>#}
{#                        <div class="small fw-bold">${res.service}</div>#}
{#                    </div>#}
{#                    <button class="btn btn-sm btn-warning rounded-circle">‚Üí</button>#}
{#                </div>#}
{#            `;#}
{#                container.appendChild(card);#}
{#            });#}
{#        }#}

{#    });#}

{#</script>#}
<script>
    document.addEventListener('DOMContentLoaded', function () {

        // --- DONN√âES depuis Symfony ---
        const allReservations = {{ allReservations|json_encode|raw }};
        const currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();

        const grid = document.getElementById('calendar-grid');
        const monthTitle = document.querySelector('.calendar-header h5');

        // =========================
        // CARTE LEAFLET
        // =========================
        const defaultCenter = [48.8566, 2.3522]; // Paris
        let map = L.map('map').setView(defaultCenter, 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const markers = [];
        allReservations.forEach(res => {
            if(res.lat && res.lng){
                const marker = L.marker([res.lat, res.lng]).addTo(map);
                marker.bindPopup(`<strong>${res.nom}</strong><br>${res.adresse || 'Adresse inconnue'}<br><em>${res.service}</em>`);
                markers.push(marker);
            }
        });
        if(markers.length){
            const bounds = L.latLngBounds(markers.map(m => m.getLatLng()));
            map.fitBounds(bounds, {padding: [50,50]});
        }

        // =========================
        // TABLEAU DES R√âSERVATIONS (7 prochaines)
        // =========================
        const upcomingReservations = allReservations
            .filter(r => {
                if(!r.date) return false;
                const rDate = new Date(r.date);
                return rDate >= new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());
            })
            .sort((a,b) => new Date(a.date) - new Date(b.date))  // tri croissant (plus proches d'abord)
            .slice(0,7); // garde max 7

        renderReservationsTable(upcomingReservations);

        function renderReservationsTable(data) {
            const tbody = document.getElementById('reservations-table-body');
            tbody.innerHTML = '';
            data.forEach(res => {
                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${res.id}</td>
                <td>${res.nom}</td>
                <td>${formatDate(res.date)}</td>
                <td>${res.service}</td>
                <td>${res.duree} min</td>
                <td><span class="badge bg-success">${res.statut}</span></td>
                <td><a href="#" class="text-decoration-underline text-dark">Voir plus</a></td>
            `;
                tbody.appendChild(row);
            });
        }

        // =========================
        // CALENDRIER
        // =========================
        initCalendar(currentYear, currentMonth);

        const [prevBtn, nextBtn] = document.querySelectorAll('.calendar-header button');
        prevBtn.addEventListener('click', () => changeMonth(-1));
        nextBtn.addEventListener('click', () => changeMonth(1));

        function changeMonth(offset) {
            currentMonth += offset;
            if(currentMonth < 0) { currentMonth = 11; currentYear--; }
            if(currentMonth > 11){ currentMonth = 0; currentYear++; }
            initCalendar(currentYear, currentMonth);
        }

        function initCalendar(year, month){
            grid.innerHTML = '';
            monthTitle.textContent = new Date(year, month).toLocaleString('fr-FR', { month: 'long', year: 'numeric' });

            // Noms des jours
            const daysOfWeek = ['Lu','Ma','Me','Je','Ve','Sa','Di'];
            daysOfWeek.forEach(day => {
                const el = document.createElement('div');
                el.className = 'day-name';
                el.textContent = day;
                grid.appendChild(el);
            });

            // D√©calage premier jour
            const firstDay = new Date(year, month, 1).getDay(); // 0=dimanche
            let startDay = firstDay - 1;
            if(startDay < 0) startDay = 6;
            for(let i=0; i<startDay; i++){ grid.appendChild(document.createElement('div')); }

            // Jours du mois
            const daysInMonth = new Date(year, month+1, 0).getDate();
            for(let day=1; day<=daysInMonth; day++){
                const btn = document.createElement('button');
                btn.className = 'day-btn';
                btn.textContent = day;

                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                btn.dataset.date = dateStr;

                const thisDate = new Date(year, month, day);
                if(thisDate < new Date(currentYear, currentMonth, currentDate.getDate())){
                    btn.classList.add('past-day');
                    btn.disabled = true;
                }

                if(allReservations.some(r => r.date === dateStr)){
                    btn.classList.add('has-reservation');
                }

                btn.addEventListener('click', function(){
                    document.querySelectorAll('.day-btn').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    updateDailySchedule(dateStr);
                });

                grid.appendChild(btn);
            }
        }

        // =========================
        // AFFICHER LES R√âSERVATIONS DU JOUR
        // =========================
        function updateDailySchedule(dateStr) {
            const container = document.getElementById('daily-schedule-container');
            container.innerHTML = '';
            const dayReservations = allReservations.filter(r => r.date === dateStr);

            if (!dayReservations.length) {
                container.innerHTML = `<p class="text-muted text-center py-3">Aucune r√©servation pour le ${formatDate(dateStr)}</p>`;
                return;
            }

            dayReservations.forEach(res => {
                const card = document.createElement('div');
                card.className = 'card mb-3 availability-card';
                card.innerHTML = `
                <div class="card-body">
                    <div class="fw-bold">${res.nom}</div>
                    <div class="small text-muted">${res.heure_debut || ''} - ${res.heure_fin || ''}</div>
                    <div class="small fw-bold">${res.service}</div>
                    <div class="small">${res.adresse || ''}</div>
                </div>
            `;
                container.appendChild(card);
            });
        }

        // =========================
        // UTILITAIRES
        // =========================
        function formatDate(dateStr) {
            if (!dateStr) return '‚Äî';
            const [y,m,d] = dateStr.split('-');
            return `${d}/${m}/${y}`;
        }

    });
</script>




</body>
</html>
