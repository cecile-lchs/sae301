<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Admin</title>
    <link rel="stylesheet" href="{{ asset('styles/app.css') }}">






    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap" rel="stylesheet">


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">


    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<style>
    .dashboard-container {
        display: flex;
        min-height: 100vh;
    }
    #map {
        height: 400px;
        width: 100%;
        border-radius: 12px;
        z-index: 1;
    }
    /* Embedded Dashboard Styles */
    .stat-card-link {
        text-decoration: none;
        color: inherit;
        display: block;
        transition: transform 0.2s ease;
    }
    .stat-card-link:hover {
        transform: translateY(-5px);
    }
    .stat-card-link:hover .stat-card {
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    /* Icons styling */
    .sidebar-nav .icon {
        font-size: 1.2rem;
        margin-right: 10px;
        vertical-align: middle;
    }

    /* Settings Button (Header) */
    .settings-btn {
        width: 48px;
        height: 48px;
        background-color: var(--bs-primary, #0d6efd);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s ease, background-color 0.3s ease;
    }
    .settings-btn:hover {
        transform: rotate(90deg);
        background-color: #0b5ed7;
    }
    .settings-btn i {
        font-size: 1.5rem;
    }
</style>

<body class="dashboard-body">

<div class="dashboard-container">
    <!-- Sidebar -->
    {# ================= SIDEBAR ================= #}
    <aside class="dashboard-sidebar">
        <div class="sidebar-header">
            <img src="{{ asset('images/logo.svg') }}" alt="Jardins Harmonie" class="sidebar-logo">
        </div>

        <nav class="sidebar-nav">
            <ul>
                <li>
                    <a href="{{ path('admin_dashboard') }}">
                        <span class="icon"><i class="bi bi-house-door"></i></span> Accueil
                    </a>
                </li>
                <li>
                    <a href="{{ path('admin_reservation') }}">
                        <span class="icon"><i class="bi bi-calendar-event"></i></span> Interventions
                    </a>
                </li>
                <li>
                    <a href="{{ path('admin_client') }}" >
                        <span class="icon"><i class="bi bi-people"></i></span> Clients
                    </a>
                </li>
                <li>
                    <a href="{{ path('admin_planning') }}" >
                        <span class="icon"><i class="bi bi-calendar-week"></i></span> Plannings
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="dashboard-main">
        <header class="dashboard-header d-flex justify-content-between align-items-center bg-white border-bottom p-4">
            <h2>Accueil</h2>
            <a href="{{ path('admin_parametres') }}" class="text-decoration-none">
                <div class="settings-btn">
                    <i class="bi bi-gear-fill"></i>
                </div>
            </a>
        </header>

        <div class="dashboard-content">
            <!-- Stats Row -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <a href="{{ path('admin_reservation') }}" class="stat-card-link">
                        <div class="stat-card">
                            <div class="stat-icon"><i class="bi bi-calendar-check"></i></div>
                            <div class="stat-info">
                                <span class="stat-label">Nombre de réservations</span>
                                <span class="stat-value">{{ totalReservations }}</span>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-md-6">
                    <a href="{{ path('admin_client') }}" class="stat-card-link">
                        <div class="stat-card">
                            <div class="stat-icon"><i class="bi bi-person-lines-fill"></i></div>
                            <div class="stat-info">
                                <span class="stat-label">Nombre de clients</span>
                                <span class="stat-value">{{ totalClients }}</span>
                            </div>
                        </div>
                    </a>
                </div>
            </div>

            <div class="row">
                <!-- Left Column: Map & List -->
                <div class="col-lg-8">
                    <!-- Map Section -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Carte des clients</h5>
                            <div id="map"></div>
                        </div>
                    </div>

                    <!-- Reservations List -->
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Liste des réservations</h5>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead>
                                    <tr>
                                        <th>N°</th>
                                        <th>Nom</th>
                                        <th>Date</th>
                                        <th>Service</th>
                                        <th>Durée</th>
                                        <th>Statut</th>
                                        <th>Action</th>
                                    </tr>
                                    </thead>
                                    <tbody id="reservations-table-body">
                                    <!-- Rows generated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Calendar & Availability -->
                <div class="col-lg-4">
                    <!-- Calendar Widget -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="calendar-header d-flex justify-content-between align-items-center mb-3">
                                <button class="btn btn-sm btn-link">&lt;</button>
                                <h5 class="m-0">Octobre 2026</h5>
                                <button class="btn btn-sm btn-link">&gt;</button>
                            </div>
                            <div class="calendar-grid" id="calendar-grid">
                                <!-- Headers -->

                                <!-- Days will be generated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Availability List -->
                    <div class="availability-list" id="daily-schedule-container">
                        <!-- Daily schedule items generated by JS -->
                        <p class="text-muted text-center py-3">Sélectionnez une date pour voir les disponibilités.</p>
                    </div>

                    <a href="{{ path('admin_parametres') }}" class="btn btn-primary w-100 mt-3 d-flex align-items-center justify-content-center gap-2">
                        <span>+</span> Ajouter indisponibilité
                    </a>
                </div>
            </div>
        </div>
    </main>
</div>



<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<!-- Custom JS for Map and Calendar -->

<script>
    document.addEventListener('DOMContentLoaded', function () {

        // --- DONNÉES depuis Symfony ---
        const allReservations = {{ allReservations|json_encode|raw }};
        const allIndisponibilites = {{ unavailabilities|json_encode|raw }};
        const currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();

        const grid = document.getElementById('calendar-grid');
        const monthTitle = document.querySelector('.calendar-header h5');

        // =========================
        // CARTE LEAFLET
        // =========================
        const defaultCenter = [48.8566, 2.3522]; // Paris
        let map = L.map('map').setView(defaultCenter, 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const markers = [];
        allReservations.forEach(res => {
            if(res.lat && res.lng){
                const marker = L.marker([res.lat, res.lng]).addTo(map);
                marker.bindPopup(`<strong>${res.nom}</strong><br>${res.adresse || 'Adresse inconnue'}<br><em>${res.service}</em>`);
                markers.push(marker);
            }
        });
        if(markers.length){
            const bounds = L.latLngBounds(markers.map(m => m.getLatLng()));
            map.fitBounds(bounds, {padding: [50,50]});
        }

        // =========================
        // TABLEAU DES RÉSERVATIONS
        // =========================
        const upcomingReservations = allReservations
            .filter(r => {
                if(!r.date) return false;
                const rDate = new Date(r.date);
                return rDate >= new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());
            })
            .sort((a,b) => new Date(a.date) - new Date(b.date))
            .slice(0,7);

        renderReservationsTable(upcomingReservations);

        function renderReservationsTable(data) {
            const tbody = document.getElementById('reservations-table-body');
            tbody.innerHTML = '';
            data.forEach(res => {
                const row = document.createElement('tr');
                const detailsUrl = `{{ path('admin_reservation_details', {id: 0}) }}`.replace('0', res.id);
                row.innerHTML = `
                <td>${res.id}</td>
                <td>${res.nom}</td>
                <td>${formatDate(res.date)}</td>
                <td>${res.service}</td>
                <td>${res.duree} min</td>
                <td><span class="badge bg-success">${res.statut}</span></td>
                <td><a href="${detailsUrl}" class="text-decoration-underline text-dark">Consulter</a></td>
            `;
                tbody.appendChild(row);
            });
        }

        // =========================
        // CALENDRIER
        // =========================
        initCalendar(currentYear, currentMonth);

        const [prevBtn, nextBtn] = document.querySelectorAll('.calendar-header button');
        prevBtn.addEventListener('click', () => changeMonth(-1));
        nextBtn.addEventListener('click', () => changeMonth(1));

        function changeMonth(offset) {
            currentMonth += offset;
            if(currentMonth < 0) { currentMonth = 11; currentYear--; }
            if(currentMonth > 11){ currentMonth = 0; currentYear++; }
            initCalendar(currentYear, currentMonth);
        }

        function initCalendar(year, month){
            grid.innerHTML = '';
            monthTitle.textContent = new Date(year, month).toLocaleString('fr-FR', { month: 'long', year: 'numeric' });

            const daysOfWeek = ['Lu','Ma','Me','Je','Ve','Sa','Di'];
            daysOfWeek.forEach(day => {
                const el = document.createElement('div');
                el.className = 'day-name';
                el.textContent = day;
                grid.appendChild(el);
            });

            const firstDay = new Date(year, month, 1).getDay(); // 0=dimanche
            let startDay = firstDay - 1;
            if(startDay < 0) startDay = 6;
            for(let i=0; i<startDay; i++){ grid.appendChild(document.createElement('div')); }

            const daysInMonth = new Date(year, month+1, 0).getDate();
            for(let day=1; day<=daysInMonth; day++){
                const btn = document.createElement('button');
                btn.className = 'day-btn';
                btn.textContent = day;

                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                btn.dataset.date = dateStr;

                const thisDate = new Date(year, month, day);
                if(thisDate < new Date(currentYear, currentMonth, currentDate.getDate())){
                    btn.classList.add('past-day');
                }

                // Check reservations
                if(allReservations.some(r => r.date === dateStr)){
                    btn.classList.add('has-reservation');
                }

                // Check indisponibilites
                if(allIndisponibilites.some(i => i.date === dateStr)){
                    btn.classList.add('unavailable');
                    btn.style.backgroundColor = '#e0e0e0'; // Gris
                    btn.style.color = '#888';
                }

                btn.addEventListener('click', function(){
                    document.querySelectorAll('.day-btn').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    updateDailySchedule(dateStr);
                });

                grid.appendChild(btn);
            }
        }

        // =========================
        // AFFICHER LES RÉSERVATIONS DU JOUR
        // =========================
        function updateDailySchedule(dateStr) {
            const container = document.getElementById('daily-schedule-container');
            container.innerHTML = '';

            // Filter reservations
            const dayReservations = allReservations.filter(r => r.date === dateStr);
            // Filter unavailabilities
            const dayIndispos = allIndisponibilites.filter(i => i.date === dateStr);

            if (!dayReservations.length && !dayIndispos.length) {
                container.innerHTML = `<p class="text-muted text-center py-3">Aucune activité pour le ${formatDate(dateStr)}</p>`;
                return;
            }

            // Render Unavailabilities
            dayIndispos.forEach(indespo => {
                const card = document.createElement('div');
                card.className = 'card mb-3 availability-card bg-secondary text-white'; // Style for unavailability
                card.innerHTML = `
                <div class="card-body">
                    <div class="fw-bold"><i class="bi bi-slash-circle me-2"></i>Indisponible</div>
                    <div class="small">${indespo.motif || 'Aucun motif'}</div>
                </div>
            `;
                container.appendChild(card);
            });

            // Render Reservations
            dayReservations.forEach(res => {
                const card = document.createElement('div');
                card.className = 'card mb-3 availability-card';
                card.innerHTML = `
                <div class="card-body">
                    <div class="fw-bold">${res.nom}</div>
                    <div class="small text-muted">${res.heure_debut || ''} - ${res.heure_fin || ''}</div>
                    <div class="small fw-bold">${res.service}</div>
                    <div class="small">${res.adresse || ''}</div>
                </div>
            `;
                container.appendChild(card);
            });
        }

        function formatDate(dateStr) {
            if (!dateStr) return '—';
            const [y,m,d] = dateStr.split('-');
            return `${d}/${m}/${y}`;
        }

    });
</script>




</body>
</html>
