<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Jardin Harmonie - Votre jardin entre de bonnes mains{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ asset('styles/app.css') }}">
    <style>
        /* Mobile Responsiveness for Step 1 */
        @media (max-width: 768px) {
            html, body {
                overflow-x: hidden;
                overflow-y: auto;
                height: auto;
                -webkit-overflow-scrolling: touch;
            }
            .reservation-container {
                flex-direction: column;
                height: auto;
                overflow: visible;
            }
            .sidebar {
                display: none;
            }
            .main-content {
                width: 100%;
                height: auto;
                overflow: visible;
                display: block; /* Override flex */
            }
            .horizontal-steps {
                width: 100%;
                justify-content: center;
                padding: 10px;
                overflow-x: auto;
                white-space: nowrap;
            }
            .scroll-content {
                height: auto;
                overflow-y: visible;
                padding-bottom: 120px; /* Space for fixed bottom bar */
                padding-left: 20px;
                padding-right: 20px;
            }
            .services-grid {
                grid-template-columns: 1fr; /* Single column for services */
            }
            .bottom-bar {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                z-index: 1000;
                background: white;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
                padding: 15px;
                display: flex;
                flex-direction: column; /* Stack price and button if needed */
                align-items: center;
                justify-content: center;
            }
            .btn-next {
                width: 100%;
                justify-content: center;
            }
            .mobile-close-btn {
                display: block;
                position: absolute;
                top: 20px;
                left: 20px;
                z-index: 1001;
            }
        }
    </style>
</head>

{% block main %}
<body class="reservation-body">

<div class="reservation-container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-content">
            <a href="{{ path('app_accueil') }}" class="btn-home-return">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                Retour à l'accueil
            </a>

            <!-- Steps Removed from Sidebar -->
        </div>

        <!-- Integrated Recap Section -->
        <div class="sidebar-recap">
            <div class="recap-content">
                <h4>Mes services</h4>
                <ul id="recap-services-list">
                    <li>Aucun service sélectionné</li>
                </ul>
            </div>
            <div class="recap-footer">
                <span class="label">Total à régler</span>
                <span class="price" id="recap-total">0 €</span>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content" style="display:flex; flex-direction:column;">
        <!-- Horizontal Steps (Top Right) -->
        <div class="horizontal-steps">
            <a href="{{ path('app_accueil') }}" class="mobile-close-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#103A21" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </a>
            <div class="step-item active">
                <div class="step-circle">1</div>
                <span class="step-label">Services</span>
            </div>
            <div class="step-item">
                <div class="step-circle">2</div>
                <span class="step-label">Date</span>
            </div>
            <div class="step-item">
                <div class="step-circle">3</div>
                <span class="step-label">Informations</span>
            </div>
            <div class="step-item">
                <div class="step-circle">4</div>
                <span class="step-label">Confirmation</span>
            </div>
            <div class="step-item">
                <div class="step-circle">5</div>
                <span class="step-label">Validation</span>
            </div>
        </div>

        <div class="scroll-content">
            <header class="content-header">
                <!-- No back button on first step -->
                <button class="btn-back" style="visibility: hidden;">← Précedent</button>
                <h1 class="page-title">Choisissez le <span class="highlight">service</span> dont votre jardin à besoin</h1>
            </header>

            {#            <form id="step1-form" onsubmit="return false;">#}
            {#                <div class="step-content active">#}
            {#                    <p class="step-description">Sélectionnez les prestations adaptées à votre jardin pour un extérieur propre, sain et harmonieux</p>#}
            {#                    #}
            {#                    <div class="services-grid">#}
            {#                        {% for service in services %}#}
            {#                            <label class="service-card">#}
            {#                                <input type="checkbox"#}
            {#                                       name="services[]"#}
            {#                                       value="{{ service.id }}"#}
            {#                                       data-price="{{ service.prix }}">#}
            {#                                <div class="card-inner">#}
            {#                                    <span class="time-badge">{{ service.dureeMinutes / 60 }}h</span>#}
            {#                                    <div class="icon-wrapper">#}
            {#                                        <img src="{{ asset('images/' ~ service.icon) }}" alt="{{ service.nom }}">#}
            {#                                    </div>#}
            {#                                    <h3>{{ service.nom }}</h3>#}
            {#                                </div>#}
            {#                            </label>#}
            {#                        {% endfor %}#}
            {#                    </div>#}

            {#                    <div id="step1-error" class="error-message"></div>#}
            {#                </div>#}
            {#            </form>#}
            <form id="step1-form" method="POST" action="{{ path('reservation_step1') }}">
                <div class="services-grid">
                    {% for service in services %}
                        <label class="service-card">
                            <input type="checkbox" name="services[]" value="{{ service.id }}" data-price="{{ service.prix }}">
                            <div class="card-inner">
                                <div class="card-top">
                                    <span class="price">{{ service.prix }}€</span>
                                    <span class="name">{{ service.nom }}</span>
                                    <span class="duration">{{ service.dureeMinutes / 60 }}h</span>
                                </div>
                                <div class="card-bottom">
                                    <div class="icon-wrapper">
                                        <img src="{{ asset('images/' ~ service.icon) }}" alt="{{ service.nom }}">
                                    </div>
                                </div>
                            </div>
                        </label>
                    {% endfor %}
                </div>

                <div id="step1-error" class="error-message" style="color: red; text-align: center; margin-top: 10px; font-weight: bold;">
                    {% if error is defined and error %}
                        {{ error }}
                    {% endif %}
                </div>
                {#                <button type="submit" class="btn-next">Suivant →</button>#}
            </form>

        </div>

        <!-- Bottom Bar -->
        <footer class="bottom-bar">
            <div class="price-container" style="display: none;"></div>
            <button type="submit" class="btn-next" id="btn-next" form="step1-form">Suivant <span class="arrow">→</span>
            </button>
        </footer>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const checkboxes = document.querySelectorAll('input[type="checkbox"][name="services[]"]');
        const btnNext = document.getElementById('btn-next');
        const recapList = document.getElementById('recap-services-list');
        const recapTotal = document.getElementById('recap-total');

        // Restore previous selection if any
        const savedServices = JSON.parse(sessionStorage.getItem('reservation_services') || '[]');
        checkboxes.forEach(cb => {
            if (savedServices.some(s => s.value === cb.value)) {
                cb.checked = true;
            }
        });

        function updateRecap() {
            const selected = [];
            let total = 0;

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    // Find name and price
                    const card = cb.closest('.service-card');
                    const name = card.querySelector('.card-top .name').textContent;
                    const price = parseFloat(cb.dataset.price || 0);

                    selected.push({ name, price, value: cb.value });
                    total += price;
                }
            });

            // Update List
            if(selected.length === 0) {
                recapList.innerHTML = '<li>Aucun service sélectionné</li>';
            } else {
                recapList.innerHTML = selected.map(s => `<li>${s.name}</li>`).join('');
            }

            // Update Total
            recapTotal.textContent = total + ' €';

            // Update Button State
            const anyChecked = selected.length > 0;
            btnNext.disabled = !anyChecked;
            btnNext.style.opacity = anyChecked ? '1' : '0.5';
            btnNext.style.cursor = anyChecked ? 'pointer' : 'not-allowed';

            // Toggle Bottom Bar Color
            const bottomBar = document.querySelector('.bottom-bar');
            if(anyChecked){
                bottomBar.classList.add('active');
            } else {
                bottomBar.classList.remove('active');
            }

            // Save current selection to session storage
            sessionStorage.setItem('reservation_services', JSON.stringify(selected.map(s => ({ value: s.value, name: s.name, price: s.price }))));
        }

        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateRecap);
        });

        // Init
        updateRecap();
    });
</script>
{% endblock %}
</body>
</html>
